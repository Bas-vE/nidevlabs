---
template: page
title: "The Diagram Editing System"
category: concepts
order: 5
---

The Diagram SDK diagram editing system is responsible for displaying and editing source file documents as graphical diagrams.

## Diagram Editing System Architecture

The following diagram illustrates the high-level architecture of the diagram editing system.

![DiagramEditingSystemRelationships]

## Diagram Editing System Theory of Operation

The [document system][DocumentSystem] uses the diagram editing system to edit Documents that are based on the [Diagram Object Model][DiOM]. When you create a [DocumentEditControl][DocumentEditControlRef] to edit a DiOM-based document, the DocumentEditControl should use a [DesignerEditControl][DesignerEditControlRef] to display the document's diagram and manage adorners and tools that the end user can interact with to edit the document's diagram.

### Model Visualization Process

In order to visualize model Elements, the diagram editing system performs the following sequence of operations:

1. The Designer system listens to the model via IModelObserver.
2. Upon a ViewElementParentViewModel seeing a component added to its model, it starts the process by asking the DesignerEditControl to find or create a viewmodel for that model.
3. This is done via the MEF plugin interface IProvideViewModels.
4. Once the appropriate ViewModel is created, it is added to the ViewElementParentViewModel’s child VewModels.
5. The new ViewModel is asked for its view via CreateVisualControl.

### Providing Custom Visuals

Visual tree size is of critical importance to WPF performance. Creating views is slow. Reparenting hierarchies is slow. This led the PlatformFramework to develop the VirtualCanvas, so we only show models that are within the user’s field of view. This, as well as a desire for cross-platform UI definition, led to the following recommended way of implementing your visualization based on the NineGridData format.

1. CreateVisualControl returns a new DiagramControl by default.
2. The DiagramControl is bound by default to an enumerable of NineGridData via the RenderData property.
3. By overriding RenderData, you can provide custom visual assets in the form of NineGridData paths.

### Adorners and Tools

One of the document system's primary roles is to manage adorners and tools, which are the primary mechanisms by which the end user edits diagram documents.

[Adorners][MSDN_Adorners] are created as part of an [AdornerLayer][MSDN_AdornerLayer] on the [DesignerEditControl.EditPanel][EditPanelRef]. While you can add and remove elements directly on the AdornerLayer, it is generally necessary to use the [AdornerManager][AdornerManagerRef] to add and remove adorners. The AdornerManager manages adorners being added and removed, and allows temporary hiding of adorners. For example, when the user drags a node, we hide the adorners.

Tools are controls in the visual tree hierarchy that handle user input to provide functionality for an editor. The active tool is managed by the DesignerEditControl. Most tools use preview events to intercept the event before it would proceed further. When a user clicks a visual FrameworkElement, a preview event fires. If the preview event is handled, the actual event is never sent. This is why clicking on a button just selects it instead of causing the button to click, unless the [OperateTool][OperateToolRef] is active.

Tools appear as a hierarchy of children below the DesignerEditControl. This hierarchy roughly correlates to priority. For example, as a mouse movement event travels down the hierarchy, the [wiring][WiringSystem] tool has the opportunity to intercept it before the text or selection tool. Generally, there is only one active tool at a time. However, the [AutoTool][AutoToolRef] encompasses a set of sub-tools, using a weighting system to set the order in which the sub-tools receive user events.

The Diagram SDK provides a set of built-in tools you can leverage and an [IDesignerTool][IDesignerToolRef] interface you can implement to create your own tools.

## Diagram Editing System Visual Tree

The diagram editing system's visual tree hierarchy starts at the DesignerEditControl and ends with the controls on the inner-most nested diagram. For example, assume take the following [Toy][Tutorials] diagram.

![ToyDiagram]

The following screenshot generated by Snoop shows the diagram editing system's full visual tree hierarchy for this Toy diagram.

![ToyDiagramVisualTree]

Note the basic structure of the diagram editing system:

* DesignerEditControl
  * ScrollViewer
    * AdornerDecorator
      * Tool Container (Grid)
        * Tools
          * RootDiagramCanvas
    * AdornerLayer
      * Adorners

Also, note how the individual tools are nested within one another. This tool hierarchy, determined by the order in which you add tools to the list returned by [DocumentEditControl.CreateDefaultTool][CreateDefaultToolRef] method, reflects the order in which tools receive the opportunity to handle user events. Finally, note how the visible diagram controls map to the visual tree:

* ToyDiagramCanvas
  * FixedProcessorControl
  * WireControl
  * ToyNodeContainerControl
    * DiagramCanvas (nested diagram)
      * FixedProcessorControl
      * WireControl
    * DiagramCanvas (border diagram)
      * ContainerTunnelControl

## Primary Classes that Participate in the Diagram Editing System

### DesignerEditControl

The [DesignerEditControl][DesignerEditControlRef] class performs the following functions:

* Contains a RootDiagramCanvas
* Creates and manages adorners
* Creates and manages tools
* Helps with selection and adorner management
* Provides zoom capabilities
* Provides a ScrollViewer to scroll content
* Manages the model to visual map
* Provides the DesignerEditControl.TryGetVisualForModel method, which takes a model Element and returns its associated visual FrameworkElement

__Tip:__ You can access the DesignerEditControl from any visual below it in the visual tree by calling the DesignerEditControl.GetDesigner method.

### RootDiagramCanvas : DiagramCanvas : OffsetCanvas

When creating a diagram, the DesignerEditControl is intended to work with an [OffsetCanvas][OffsetCanvasRef], which provides an editing surface in the form of a [Panel][MSDN_Panel] with no size limit that can be scrolled using a [ScrollViewer][MSDN_ScrollViewer]. The [DiagramCanvas][DiagramCanvasRef] class derives from OffsetCanvas and adds diagram functionality. Its primary use is to facilitate the binding of model elements to data templates. The [RootDiagramCanvas][RootDiagramCanvasRef] class derives from DiagramCanvas and therefore inherits the binding features of the canvas as well as acting as the root of a hierarchy of [FrameworkElements][MSDN_FrameworkElements] that are data bound to model elements. You can derive your own type from RootDiagramCanvas if your root diagram requires special features. However, this level of customization is not generally necessary.

### AutoTool

The [AutoTool][AutoToolRef] allows the [wiring][WiringSystem], selection and placement tools to be active in the visual tree, receiving events in priority order. This order is defined by the order of the elements in the AutoTool's [Tools][ToolsRef] collection.

### NavigateTool

The [NavigateTool][NavigateToolRef] allows the user to use the mouse to click and drag to scroll around the OffsetCanvas like a map, instead of drag selecting elements. Like the OperateTool, this tool turns off preview events.

### OperateTool

The [OperateTool][OperateToolRef] allows the user to manipulate their controls as they would at runtime. This tool stops the other tools from receiving preview events, preventing user events from reaching the controls themselves. Thus, when you click a combo box, instead of the SelectionTool selecting it, the combo box actually receives the event and drops down.

### PlacementTool

The [PlacementTool][PlacementToolRef] places nodes from a [DesignerPalette][DesignerPaletteRef]. This tool includes the following functionality:

* It takes the XML representation of a node from a [PaletteElement][PaletteElementConcept] and creates the model representation using the appropriate parser.
* It interactively displays placement activity in progress, performing parenting when appropriate to place the given node on the correct diagram. For example, when the mouse passes over a structure during a placement operation, the placement tool indicates that the dropped item would be dropped in that structure if the placement operation ended immediately.
* It fires the [PlacementToolRelease][PlacementToolReleaseRef] event when placement finishes (success or failure/cancel) and notifies [IPlacementNotify][IPlacementNotifyRef] implementers to give them the opportunity to provide post-placement behavior.
* It works with placement plug-ins to provide custom placement semantics. For example, most shapes on the LabVIEW Web UI Builder palette provide interactive text to explain to the user how to create the shape with a sequence of clicks. This is accomplished using the [IPlacementHelperTool][IPlacementHelperToolRef] interface, defined on a placed item, and the [IPlacementHelperMasterTool][IPlacementHelperMasterToolRef] interface, defined on the PlacementTool.
* It can be canceled with the escape key, or by clicking outside of the diagram.

#### SelectionTool

The [SelectionTool][SelectionToolRef] manages the selection of elements. This tool includes the following functionality:

* It sends an event when selection changes. Other parts of the UI react to this event. For example, the ribbon and the properties grid update to reflect the current selection.
* It manages the selection adorner and any custom adorners provided by the selected elements. The selected item can also provide adorners, either by push, using the [IPushAdornerFactory][IPushAdornerFactoryRef] and [IDesignerToolAdorner][IDesignerToolAdornerRef] interfaces, or by pull, using the [ISelectableItem][ISelectableItemRef] interface's [GetSoftSelectAdorners][GetSoftSelectAdornersRef] and [GetHardSelectAdorners][GetHardSelectAdornersRef] callbacks.
* It manages the movement of selected elements, including copy-paste semantics - Ctrl+Drag on an element to create a copy and Ctrl+Drag in empty diagram space to create additional space.
* It tags selection on transactions so that undo/redo can return the program to the previous selection state.

### TextTool

The [TextTool][TextToolRef] provides text editing behavior for text elements such as [TextBlock][MSDN_TextBlock], [ComboBox][MSDN_ComboBox], etc. Because of the way we implement tools, using a [TextBox][MSDN_TextBox] in a diagram node does not work, as the click is intercepted. Instead, we use the TextTool and its attached properties and interfaces to allow the user to edit text.

### WiringTool

The WiringTool provides visual [wiring][WiringSystem] semantics. This tool includes the following functionality:

* It displays a small lollipop-like terminal adorner and terminal description when the mouse is near a [Terminal][TerminalRef].
* It displays all the terminal adorners for a node when the mouse is over the node.
* It starts a wiring operation and manages the wiring transaction as the user clicks to create tack points.
* It finishes a wiring operation when the user clicks on a terminal or wire.
* It cancels a wiring operation when the user presses the escape key, double-clicks on the diagram, or clicks outside the diagram.





[DiOM]: ../InProgress.html
[DocumentSystem]: ../document-system/document-system.html
[PaletteElementConcept]: ../InProgress.html
[Tutorials]: ../InProgress.html
[WiringSystem]: ../InProgress.html	

[AdornerManagerRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_AdornerManager.htm
[AutoToolRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_AutoTool.htm
[CreateDefaultToolRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/M_NationalInstruments_SourceModel_Shell_DocumentEditControl_CreateDefaultTool.htm
[DesignerEditControlRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_DesignerEditControl.htm
[DesignerPaletteRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_DesignerPalette.htm
[DiagramCanvasRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_DiagramCanvas.htm
[DocumentEditControlRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Shell_DocumentEditControl.htm
[EditPanelRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/P_NationalInstruments_SourceModel_Designer_DesignerEditControl_EditPanel.htm
[GetHardSelectAdornersRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/M_NationalInstruments_SourceModel_Designer_ISelectableItem_GetHardSelectAdorners.htm
[GetSoftSelectAdornersRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/M_NationalInstruments_SourceModel_Designer_ISelectableItem_GetSoftSelectAdorners.htm
[IDesignerToolRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_IDesignerTool.htm
[IDesignerToolAdornerRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_IDesignerToolAdorner.htm
[IPlacementHelperMasterToolRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_IPlacementHelperMasterTool.htm
[IPlacementHelperToolRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_IPlacementHelperTool.htm
[IPlacementNotifyRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_IPlacementNotify.htm
[IPushAdornerFactoryRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_IPushAdornerFactory.htm
[ISelectableItemRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_ISelectableItem.htm
[NavigateToolRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_NavigateTool.htm
[OffsetCanvasRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_OffsetCanvas.htm
[OperateToolRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_OperateTool.htm
[PlacementToolRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_PlacementTool.htm
[PlacementToolReleaseRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/E_NationalInstruments_SourceModel_Designer_PlacementTool_PlacementToolRelease.htm
[RootDiagramCanvasRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_RootDiagramCanvas.htm
[SelectionToolRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_SelectionTool.htm
[TerminalRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Modeling_Terminal.htm
[TextToolRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/T_NationalInstruments_SourceModel_Designer_TextTool.htm
[ToolsRef]: http://xgen.amer.corp.natinst.com/DiagramSDK/html/P_NationalInstruments_SourceModel_Designer_AutoTool_Tools.htm


[MSDN_Adorners]: http://msdn.microsoft.com/en-us/library/ms743737.aspx
[MSDN_AdornerLayer]: http://msdn.microsoft.com/en-us/library/system.windows.documents.adornerlayer.aspx
[MSDN_ComboBox]: http://msdn.microsoft.com/en-us/library/system.windows.forms.combobox.aspx
[MSDN_FrameworkElements]: http://msdn.microsoft.com/en-us/library/system.windows.frameworkelement.aspx
[MSDN_Panel]: http://msdn.microsoft.com/en-us/library/system.windows.forms.panel.aspx
[MSDN_ScrollViewer]: http://msdn.microsoft.com/en-us/library/ms750665.aspx
[MSDN_TextBlock]: http://msdn.microsoft.com/en-us/library/system.windows.controls.textblock.aspx
[MSDN_TextBox]: http://msdn.microsoft.com/en-us/library/system.windows.forms.textbox.aspx

[DiagramEditingSystemRelationships]: DiagramEditingSystemRelationships.png
[ToyDiagram]: ToyDiagramSmall.png
[ToyDiagramVisualTree]: ToyDiagramVisualTree.png
